<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LedgerX - Enterprise Invoice Intelligence</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0E7490;
            --primary-dark: #164E63;
            --primary-light: #06B6D4;
            --accent: #38BDF8;
            --success: #22C55E;
            --warning: #FACC15;
            --danger: #EF4444;
            --info: #3B82F6;
            --bg-main: #F0F9FF;
            --text-main: #0F172A;
            --text-muted: #64748B;
            --border: rgba(148,163,184,0.2);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
            line-height: 1.6;
        }
        
        .container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #0F172A 0%, #1E293B 100%);
            color: white;
            padding: 24px 16px;
            position: fixed;
            height: 100vh;
            box-shadow: 4px 0 24px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 40px;
            padding: 0 12px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-item {
            padding: 14px 16px;
            margin: 6px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: rgba(56,189,248,0.15);
            color: white;
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(14,116,144,0.4);
        }
        
        .nav-item i { width: 20px; font-size: 18px; }
        
        /* Main */
        .main {
            margin-left: 260px;
            flex: 1;
            padding: 40px;
            width: calc(100% - 260px);
        }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .page-subtitle {
            color: var(--text-muted);
            font-size: 16px;
            margin-bottom: 32px;
        }
        
        /* Cards */
        .card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
        }
        
        .card-label { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; }
        .card-value { font-size: 40px; font-weight: 800; color: var(--primary); margin-bottom: 6px; }
        .card-trend { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        
        /* KPI */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .kpi-card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); border: 1px solid var(--border); position: relative; }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(180deg, var(--primary), var(--primary-light)); border-radius: 16px 0 0 16px; }
        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .kpi-label { font-size: 13px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }
        .kpi-icon { font-size: 28px; opacity: 0.7; }
        .kpi-icon.blue { color: #3b82f6; }
        .kpi-icon.green { color: #22c55e; }
        .kpi-icon.orange { color: #f59e0b; }
        .kpi-value { font-size: 42px; font-weight: 900; color: var(--text-main); line-height: 1; margin-bottom: 8px; }
        .kpi-trend { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        
        /* Upload */
        .upload-zone {
            background: white;
            border: 3px dashed var(--primary-light);
            border-radius: 20px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 32px;
        }
        
        .upload-zone:hover { border-color: var(--primary); background: rgba(6,182,212,0.03); }
        .upload-zone.dragover { border-color: var(--primary); background: rgba(6,182,212,0.08); box-shadow: 0 8px 32px rgba(14,116,144,0.2); }
        .upload-icon { font-size: 72px; color: var(--primary-light); margin-bottom: 20px; }
        .upload-text { font-size: 22px; font-weight: 700; margin-bottom: 10px; }
        .upload-subtext { color: var(--text-muted); font-size: 15px; }
        .file-formats { display: flex; justify-content: center; gap: 16px; margin-top: 20px; }
        .format-badge { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 10px 18px; border-radius: 8px; font-weight: 600; font-size: 13px; }
        
        /* Table */
        .table-box { background: white; border-radius: 16px; box-shadow: 0 2px 16px rgba(0,0,0,0.06); overflow: hidden; border: 1px solid var(--border); }
        .table-head { padding: 24px 28px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, rgba(14,116,144,0.05), rgba(6,182,212,0.05)); }
        .table-title { font-size: 20px; font-weight: 700; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 16px 24px; text-align: left; font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; background: rgba(248,250,252,0.8); }
        td { padding: 18px 24px; border-top: 1px solid var(--border); font-size: 14px; }
        tbody tr:hover { background: rgba(6,182,212,0.03); cursor: pointer; }
        
        /* Badge */
        .badge { padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-success { background: rgba(34,197,94,0.12); color: #16A34A; }
        .badge-danger { background: rgba(239,68,68,0.12); color: #DC2626; }
        .badge-warning { background: rgba(250,204,21,0.12); color: #D97706; }
        .badge-info { background: rgba(59,130,246,0.12); color: #2563EB; }
        
        /* Button */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(14,116,144,0.3);
        }
        
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(14,116,144,0.4); }
        .btn-secondary { background: white; color: var(--text-main); border: 2px solid var(--border); }
        .btn-icon { padding: 8px 12px; border-radius: 8px; cursor: pointer; background: rgba(148,163,184,0.1); color: var(--text-muted); }
        .btn-icon:hover { background: var(--primary); color: white; }
        
        /* Status */
        .status-indicator { display: inline-flex; align-items: center; gap: 10px; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; }
        .status-indicator.connected { background: rgba(34,197,94,0.12); color: var(--success); }
        .status-indicator.disconnected { background: rgba(239,68,68,0.12); color: var(--danger); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Stats */
        .stats-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-chip { padding: 18px 20px; background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .stat-chip .label { font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }
        .stat-chip .value { font-size: 28px; font-weight: 800; color: var(--primary); }
        
        /* Login */
        .login-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(14,116,144,0.95), rgba(22,78,99,0.95));
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .login-backdrop.active { display: flex; }
        
        .login-modal {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 25px 70px rgba(0,0,0,0.5);
        }
        
        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }
        
        .modal-backdrop.active { display: flex; }
        .modal { background: white; border-radius: 20px; max-width: 900px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 70px rgba(0,0,0,0.4); }
        .modal-header { padding: 28px 32px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 22px; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-muted); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: rgba(239,68,68,0.1); color: var(--danger); }
        .modal-body { padding: 32px; }
        
        /* Perf Metric */
        .perf-metric { background: linear-gradient(135deg, #EFF6FF, #DBEAFE); padding: 32px; border-radius: 16px; margin-bottom: 28px; border: 2px solid #BFDBFE; }
        .perf-label { font-size: 12px; color: #1E40AF; font-weight: 800; text-transform: uppercase; margin-bottom: 12px; }
        .perf-value-huge { font-size: 56px; font-weight: 900; line-height: 1; margin-bottom: 10px; }
        .perf-subtitle { font-size: 14px; color: #64748b; }
        
        /* Detail Grid */
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .detail-item { padding: 18px; background: #F8FAFC; border-radius: 10px; border-left: 4px solid var(--primary); }
        .detail-label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
        .detail-value { font-size: 18px; font-weight: 700; color: var(--text-main); }
        
        /* Empty */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        
        /* Alert */
        .alert { padding: 16px 20px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; font-weight: 500; border-left: 4px solid; }
        .alert-success { background: rgba(34,197,94,0.1); color: #16A34A; border-color: var(--success); }
        .alert-error { background: rgba(239,68,68,0.1); color: #DC2626; border-color: var(--danger); }
        
        /* Spinner */
        .spinner { border: 3px solid rgba(14,116,144,0.1); border-top: 3px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: static; }
            .main { margin-left: 0; padding: 20px; width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Login -->
    <div id="loginModal" class="login-backdrop active">
        <div class="login-modal">
            <div style="text-align: center; margin-bottom: 32px;">
                <div style="font-size: 48px; color: var(--primary); margin-bottom: 16px;"><i class="fas fa-microchip"></i></div>
                <h2 style="font-size: 28px; font-weight: 800; color: var(--primary); margin-bottom: 8px;">LedgerX</h2>
                <p style="color: var(--text-muted);">Enterprise Invoice Intelligence</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Username</label>
                <input type="text" id="loginUsername" value="admin" 
                    style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px;"
                    onkeypress="if(event.key==='Enter') document.getElementById('loginPassword').focus()">
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Password</label>
                <input type="password" id="loginPassword" value="admin123" 
                    style="width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px;"
                    onkeypress="if(event.key==='Enter') login()">
            </div>
            
            <div id="loginError" style="display: none; padding: 12px; background: rgba(239,68,68,0.1); border-left: 4px solid #EF4444; border-radius: 8px; margin-bottom: 16px; color: #DC2626;"></div>
            
            <button onclick="login()" class="btn btn-primary" style="width: 100%; padding: 14px; justify-content: center;">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
            
            <div style="padding: 16px; background: var(--bg-main); border-radius: 10px; margin-top: 20px; text-align: center; font-size: 13px; color: var(--text-muted);">
                <div style="font-weight: 600; color: var(--text-main); margin-bottom: 8px;">Demo Credentials Pre-filled</div>
                <div>Click "Sign In" to continue</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="logo"><i class="fas fa-microchip"></i> LedgerX</div>
            <nav>
                <div class="nav-item active" data-page="dashboard"><i class="fas fa-chart-line"></i><span>Dashboard</span></div>
                <div class="nav-item" data-page="upload"><i class="fas fa-upload"></i><span>Upload Invoice</span></div>
                <div class="nav-item" data-page="history"><i class="fas fa-history"></i><span>History</span></div>
                <div class="nav-item" data-page="usage"><i class="fas fa-dollar-sign"></i><span>Usage</span></div>
            </nav>
            <div style="margin-top: auto; padding-top: 32px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div id="connectionStatus" class="status-indicator"><div class="status-dot"></div><span>Connecting...</span></div>
                <div style="margin-top: 16px; font-size: 12px; color: rgba(255,255,255,0.5);">
                    <div>v3.1</div>
                    <div id="userInfo">Offline</div>
                </div>
            </div>
        </div>
        
        <div class="main">
            <!-- Dashboard -->
            <div id="dashboard" class="page active">
                <h1 class="page-title">üìä Dashboard</h1>
                <p class="page-subtitle">Real-time invoice processing insights</p>
                
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">Total Invoices</div>
                            <div class="kpi-icon blue"><i class="fas fa-file-invoice"></i></div>
                        </div>
                        <div class="kpi-value" id="kpiTotal">0</div>
                        <div class="kpi-trend"><i class="fas fa-database"></i> From API</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">Quality Model</div>
                            <div class="kpi-icon green"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="kpi-value">87.2%</div>
                        <div class="kpi-trend"><i class="fas fa-arrow-up"></i> Accuracy</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">Failure Model</div>
                            <div class="kpi-icon orange"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                        <div class="kpi-value">86.7%</div>
                        <div class="kpi-trend"><i class="fas fa-arrow-up"></i> Accuracy</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">Document AI</div>
                            <div class="kpi-icon blue"><i class="fas fa-robot"></i></div>
                        </div>
                        <div class="kpi-value" id="kpiDocAI">0</div>
                        <div class="kpi-trend"><i class="fas fa-cloud"></i> /1000</div>
                    </div>
                </div>
                
                <div class="table-box">
                    <div class="table-head">
                        <h3 class="table-title">üìã Recent Invoices</h3>
                        <button class="btn btn-secondary btn-icon" onclick="loadInvoices()"><i class="fas fa-sync"></i></button>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Invoice #</th><th>Vendor</th><th>Amount</th><th>Quality</th><th>Risk</th><th>Date</th></tr>
                        </thead>
                        <tbody id="invoiceTable">
                            <tr><td colspan="6" class="empty-state"><div class="empty-icon"><i class="fas fa-inbox"></i></div><p>No invoices yet</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Upload -->
            <div id="upload" class="page">
                <h1 class="page-title">üì§ Upload Invoice</h1>
                <p class="page-subtitle">Process with AI-powered OCR</p>
                
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf" style="display:none">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <div class="upload-text">Drop Invoice Here</div>
                    <div class="upload-subtext">95% OCR accuracy</div>
                    <div class="file-formats">
                        <span class="format-badge"><i class="fas fa-file-image"></i> JPG/PNG</span>
                        <span class="format-badge"><i class="fas fa-file-pdf"></i> PDF</span>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 32px;" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-upload"></i> Select File
                    </button>
                </div>
                
                <div id="uploadResult" style="display: none;" class="card">
                    <div id="resultContent"></div>
                </div>
            </div>

            <!-- History -->
            <div id="history" class="page">
                <h1 class="page-title">üìú History</h1>
                <p class="page-subtitle">All processed invoices</p>
                
                <div class="stats-summary">
                    <div class="stat-chip"><span class="label">Total</span><span class="value" id="statTotal">0</span></div>
                    <div class="stat-chip"><span class="label">Approved</span><span class="value" style="color: var(--success);" id="statApproved">0</span></div>
                    <div class="stat-chip"><span class="label">Review</span><span class="value" style="color: var(--warning);" id="statPending">0</span></div>
                    <div class="stat-chip"><span class="label">High Risk</span><span class="value" style="color: var(--danger);" id="statRisk">0</span></div>
                </div>
                
                <div class="table-box">
                    <div class="table-head">
                        <h3 class="table-title">All Invoices</h3>
                        <button class="btn btn-secondary btn-icon" onclick="loadInvoices()"><i class="fas fa-sync"></i></button>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Invoice #</th><th>Vendor</th><th>Amount</th><th>Quality</th><th>Risk</th><th>Date</th></tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr><td colspan="6" class="empty-state"><div class="empty-icon"><i class="fas fa-history"></i></div><p>No history</p></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Usage -->
            <div id="usage" class="page">
                <h1 class="page-title">üí∞ Usage</h1>
                <p class="page-subtitle">API usage and costs</p>
                
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">Document AI</div>
                            <div class="kpi-icon blue"><i class="fas fa-file-alt"></i></div>
                        </div>
                        <div class="kpi-value" id="usagePages">0</div>
                        <div class="kpi-trend"><i class="fas fa-cloud"></i> /1000</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-label">Cost</div>
                            <div class="kpi-icon green"><i class="fas fa-dollar-sign"></i></div>
                        </div>
                        <div class="kpi-value" id="usageCost">$0</div>
                        <div class="kpi-trend"><i class="fas fa-info-circle"></i> This month</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal-backdrop" onclick="if(event.target.id==='invoiceModal') closeModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">Invoice Details</h2>
                <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="perf-metric">
                    <div class="perf-label">QUALITY SCORE</div>
                    <div class="perf-value-huge" id="modalScore" style="color: var(--success)">--</div>
                    <div class="perf-subtitle" id="modalSubtitle">Results</div>
                </div>
                <div class="detail-grid">
                    <div class="detail-item"><div class="detail-label">VENDOR</div><div class="detail-value" id="modalVendor">--</div></div>
                    <div class="detail-item"><div class="detail-label">AMOUNT</div><div class="detail-value" id="modalAmount">--</div></div>
                    <div class="detail-item"><div class="detail-label">DATE</div><div class="detail-value" id="modalDate">--</div></div>
                    <div class="detail-item"><div class="detail-label">QUALITY</div><div class="detail-value" id="modalQuality">--</div></div>
                    <div class="detail-item"><div class="detail-label">RISK</div><div class="detail-value" id="modalRisk">--</div></div>
                    <div class="detail-item"><div class="detail-label">CONFIDENCE</div><div class="detail-value" id="modalConf">--</div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://ledgerx-api-zyz6umftna-uc.a.run.app';
        let token = null;
        
        console.log('üöÄ LedgerX v2.0 Clean');
        
        async function api(e, o = {}) {
            const h = {};
            if (token && !o.skipAuth) h['Authorization'] = `Bearer ${token}`;
            if (o.body && typeof o.body === 'string') h['Content-Type'] = 'application/json';
            try {
                const r = await fetch(`${API}${e}`, { ...o, headers: h });
                if (!r.ok) throw new Error(`${r.status}`);
                return r.headers.get('content-type')?.includes('json') ? await r.json() : await r.text();
            } catch (err) { console.error('API Error:', err); throw err; }
        }
        
        async function checkHealth() {
            try {
                const h = await api('/health', { skipAuth: true });
                console.log('‚úÖ Health:', h);
                document.getElementById('connectionStatus').className = 'status-indicator connected';
                document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div><span>Active</span>';
            } catch {
                document.getElementById('connectionStatus').className = 'status-indicator disconnected';
                document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div><span>Offline</span>';
            }
        }
        
        async function login() {
            const u = document.getElementById('loginUsername').value;
            const p = document.getElementById('loginPassword').value;
            const e = document.getElementById('loginError');
            
            if (!u || !p) { e.textContent = 'Enter credentials'; e.style.display = 'block'; return; }
            
            try {
                const f = new URLSearchParams();
                f.append('username', u);
                f.append('password', p);
                
                const r = await fetch(`${API}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: f
                });
                
                if (!r.ok) throw new Error('Invalid');
                
                const d = await r.json();
                token = d.access_token;
                
                console.log('‚úÖ Login OK');
                document.getElementById('userInfo').textContent = `User: ${u}`;
                document.getElementById('loginModal').classList.remove('active');
                
                loadInvoices();
                loadUsage();
                
            } catch (err) {
                console.error('‚ùå Login failed');
                e.textContent = 'Invalid credentials';
                e.style.display = 'block';
            }
        }
        
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const pg = document.getElementById(id);
            if (pg) pg.classList.add('active');
            const nv = document.querySelector(`.nav-item[data-page="${id}"]`);
            if (nv) nv.classList.add('active');
            if (id === 'history') loadInvoices();
            if (id === 'usage') loadUsage();
        }
        
        async function loadInvoices() {
            console.log('üì• Loading invoices');
            if (!token) return;
            
            try {
                const d = await api('/user/invoices');
                const tb = document.getElementById('invoiceTable') || document.getElementById('historyTable');
                if (!tb) return;
                
                if (!d.invoices || !d.invoices.length) {
                    tb.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-icon"><i class="fas fa-inbox"></i></div><p>No invoices. Upload one!</p></td></tr>';
                    ['kpiTotal', 'statTotal', 'statApproved', 'statPending', 'statRisk'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = '0';
                    });
                    return;
                }
                
                tb.innerHTML = d.invoices.map(inv => {
                    const qc = inv.quality_prediction === 'good' ? 'success' : 'danger';
                    const fc = inv.failure_prediction === 'safe' ? 'success' : 'warning';
                    return `<tr onclick='showModal(${JSON.stringify(inv).replace(/'/g, "\\'")})'><td>${inv.invoice_number || inv.id || 'N/A'}</td><td>${inv.vendor_name || 'Unknown'}</td><td>$${(inv.total_amount || 0).toFixed(2)}</td><td><span class="badge badge-${qc}">${(inv.quality_prediction || 'N/A').toUpperCase()}</span></td><td><span class="badge badge-${fc}">${(inv.failure_prediction || 'N/A').toUpperCase()}</span></td><td>${inv.created_at ? new Date(inv.created_at).toLocaleDateString() : 'N/A'}</td></tr>`;
                }).join('');
                
                const t = d.invoices.length;
                const g = d.invoices.filter(i => i.quality_prediction === 'good' && i.failure_prediction === 'safe').length;
                const r = d.invoices.filter(i => i.quality_prediction === 'good' && i.failure_prediction !== 'safe').length;
                const h = d.invoices.filter(i => i.quality_prediction !== 'good').length;
                
                ['kpiTotal', 'statTotal'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = t; });
                const sa = document.getElementById('statApproved'); if (sa) sa.textContent = g;
                const sp = document.getElementById('statPending'); if (sp) sp.textContent = r;
                const sr = document.getElementById('statRisk'); if (sr) sr.textContent = h;
                
            } catch (err) { console.error('‚ùå Load failed:', err); }
        }
        
        async function loadUsage() {
            console.log('üìä Usage');
            if (!token) return;
            try {
                const u = await api('/admin/document-ai-usage');
                const c = u.usage_this_month || 0;
                ['usagePages', 'kpiDocAI'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = c; });
                const cost = c * 0.001;
                const ce = document.getElementById('usageCost');
                if (ce) ce.textContent = `$${cost.toFixed(2)}`;
            } catch (err) { console.error('‚ùå Usage failed:', err); }
        }
        
        const zone = document.getElementById('uploadZone');
        const input = document.getElementById('fileInput');
        
        if (zone && input) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                zone.addEventListener(e, evt => { evt.preventDefault(); evt.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(e => zone.addEventListener(e, () => zone.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(e => zone.addEventListener(e, () => zone.classList.remove('dragover')));
            zone.addEventListener('drop', e => upload(e.dataTransfer.files));
            input.addEventListener('change', e => upload(e.target.files));
        }
        
        async function upload(files) {
            if (!files || !files.length) return;
            if (!token) { alert('Login required'); return; }
            
            const f = files[0];
            const res = document.getElementById('uploadResult');
            const con = document.getElementById('resultContent');
            if (!res || !con) return;
            
            res.style.display = 'block';
            con.innerHTML = '<div style="text-align:center;padding:40px"><div class="spinner"></div><p style="margin-top:20px">Processing...</p></div>';
            
            try {
                const fd = new FormData();
                fd.append('file', f);
                
                const r = await fetch(`${API}/upload/image`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: fd
                });
                
                if (!r.ok) throw new Error(`${r.status}`);
                
                const d = await r.json();
                console.log('‚úÖ Upload OK:', d);
                
                const qc = d.quality?.prediction === 'good' ? 'success' : 'danger';
                const fc = d.failure?.prediction === 'safe' ? 'success' : 'warning';
                
                con.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i><div><strong>Success!</strong><br>${f.name} processed</div></div><div class="detail-grid"><div class="detail-item"><div class="detail-label">QUALITY</div><div class="detail-value"><span class="badge badge-${qc}">${(d.quality?.prediction || 'N/A').toUpperCase()}</span></div></div><div class="detail-item"><div class="detail-label">CONFIDENCE</div><div class="detail-value">${((d.quality?.confidence || 0) * 100).toFixed(1)}%</div></div><div class="detail-item"><div class="detail-label">RISK</div><div class="detail-value"><span class="badge badge-${fc}">${(d.failure?.prediction || 'N/A').toUpperCase()}</span></div></div><div class="detail-item"><div class="detail-label">TIME</div><div class="detail-value">${(d.processing_time_ms || 0).toFixed(0)}ms</div></div></div><div style="text-align:right;margin-top:20px"><button class="btn btn-secondary" onclick="document.getElementById('uploadResult').style.display='none'"><i class="fas fa-times"></i> Close</button><button class="btn btn-primary" onclick="showPage('history')"><i class="fas fa-history"></i> History</button></div>`;
                
                setTimeout(() => { loadInvoices(); loadUsage(); }, 1000);
                
            } catch (err) {
                console.error('‚ùå Upload failed:', err);
                con.innerHTML = `<div class="alert alert-error"><i class="fas fa-times-circle"></i><div><strong>Failed</strong><br>${err.message}</div></div><button class="btn btn-secondary" onclick="document.getElementById('uploadResult').style.display='none'" style="margin-top:16px"><i class="fas fa-times"></i> Close</button>`;
            }
        }
        
        function showModal(inv) {
            const d = typeof inv === 'string' ? JSON.parse(inv) : inv;
            document.getElementById('modalTitle').textContent = `Invoice: ${d.invoice_number || d.id}`;
            const sc = ((d.quality_confidence || 0) * 100);
            document.getElementById('modalScore').textContent = sc.toFixed(1);
            document.getElementById('modalScore').style.color = sc > 70 ? '#EF4444' : sc > 40 ? '#FACC15' : '#22C55E';
            document.getElementById('modalSubtitle').textContent = sc > 70 ? 'High risk' : sc > 40 ? 'Medium risk' : 'Low risk';
            document.getElementById('modalVendor').textContent = d.vendor_name || 'Unknown';
            document.getElementById('modalAmount').textContent = `$${(d.total_amount || 0).toFixed(2)}`;
            document.getElementById('modalDate').textContent = d.invoice_date || d.created_at || 'N/A';
            document.getElementById('modalQuality').textContent = (d.quality_prediction || 'N/A').toUpperCase();
            document.getElementById('modalRisk').textContent = (d.failure_prediction || 'N/A').toUpperCase();
            document.getElementById('modalConf').textContent = `${sc.toFixed(1)}%`;
            document.getElementById('invoiceModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('invoiceModal').classList.remove('active');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéØ Init');
            document.querySelectorAll('.nav-item').forEach(i => i.addEventListener('click', () => showPage(i.getAttribute('data-page'))));
            checkHealth();
            console.log('‚úÖ Ready');
        });
    </script>
</body>
</html>