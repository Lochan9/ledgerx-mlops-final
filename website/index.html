<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Billing Dashboard</title>
    <style>
        :root {
            --success: #34D399;
            --warning: #FBBF24;
            --danger: #EF4444;
            --text-muted: #6B7280;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .section {
            margin-bottom: 32px;
        }

        .progress-container {
            background: #E5E7EB;
            border-radius: 8px;
            height: 16px;
            width: 100%;
            margin-top: 4px;
        }

        .progress-bar {
            height: 16px;
            border-radius: 8px;
            width: 0%;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .alert-danger {
            background: #FEE2E2;
            border-left: 4px solid var(--danger);
        }

        .alert-warning {
            background: #FEF3C7;
            border-left: 4px solid var(--warning);
        }

        h2 {
            margin-bottom: 8px;
        }

        span {
            font-weight: bold;
        }
    </style>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- GCP Credits Section -->
    <div class="section">
        <h2>GCP Credits</h2>
        <div>Used: <span id="creditsUsed">$0.00</span></div>
        <div>Remaining: <span id="creditsRemaining">$0.00</span></div>
        <div>Days Left: <span id="daysRemaining">0</span></div>
        <div>Percent: <span id="creditPercent">0%</span></div>
        <div class="progress-container">
            <div class="progress-bar" id="creditProgressBar" style="background: var(--success);"></div>
        </div>
    </div>

    <!-- Document AI Section -->
    <div class="section">
        <h2>Document AI Usage</h2>
        <div>Used: <span id="docAiUsed">0</span></div>
        <div>Remaining: <span id="docAiRemaining">0</span></div>
        <div>Percent: <span id="docAiPercent">0%</span></div>
        <div class="progress-container">
            <div class="progress-bar" id="docAiProgressBar" style="background: var(--success);"></div>
        </div>
        <div>Usage Table: <span id="docAiTableUsage">0 / 1000 free</span></div>
        <div>Reset Date: <span id="docAiReset">N/A</span></div>
    </div>

    <!-- Budget Alerts -->
    <div id="budgetAlertZone" class="section"></div>

    <!-- Total Monthly Cost -->
    <div class="section">
        <h2>Total Monthly Cost</h2>
        <span id="totalMonthlyCost">$0.00</span>
    </div>

    <!-- Cache Stats -->
    <div class="section">
        <h2>Cache Stats</h2>
        <div>Hit Rate: <span id="cacheHitRate">0%</span></div>
        <div>Hit Rate Live: <span id="cacheHitRateLive">0%</span></div>
    </div>

    <!-- Today's Cost -->
    <div class="section">
        <h2>Today's Cost</h2>
        <span id="todayCost">$0.00</span>
    </div>

    <!-- Settings Document AI -->
    <div class="section">
        <h2>Settings Document AI</h2>
        <div>Used: <span id="settingsDocAiUsed">0</span></div>
        <div>Remaining: <span id="settingsDocAiRemaining">1000</span></div>
        <div>Percent: <span id="settingsDocAiPercent">0%</span></div>
        <div class="progress-container">
            <div class="progress-bar" id="settingsDocAiBar" style="background: var(--success);"></div>
        </div>
    </div>

    <script>
        // --- Mock STATE and BILLING objects for demo purposes ---
        const STATE = {
            token: 'demo-token',
            apiUrl: 'https://api.example.com',
            invoices: Array(0) // mock invoice count
        };

        const BILLING = {
            gcpCredits: { used: 0, remaining: 100, total: 100, daysLeft: 30 },
            documentAI: { used: 0, freeLimit: 1000, resetDate: new Date() },
            costs: { serviceA: 0, serviceB: 0 }
        };

        // --- Helper Functions ---
        async function fetchDocumentAIUsage() {
            try {
                if (!STATE.token) return STATE.invoices.length;

                const res = await fetch(`${STATE.apiUrl}/admin/document-ai-usage`, {
                    headers: { 'Authorization': `Bearer ${STATE.token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    return data.usage_this_month || 0;
                }
                return STATE.invoices.length;
            } catch (error) {
                console.error('Error fetching Document AI usage:', error);
                return STATE.invoices.length;
            }
        }

        function getUsageColor(used, warning = 700, danger = 900) {
            if (used > danger) return 'var(--danger)';
            if (used > warning) return 'var(--warning)';
            return 'var(--success)';
        }

        async function updateBillingDashboard() {
            // Fetch Document AI usage
            const docAiUsed = await fetchDocumentAIUsage();
            BILLING.documentAI.used = docAiUsed;

            // Update GCP Credits
            const { used: creditsUsed, remaining: creditsRemaining, total, daysLeft } = BILLING.gcpCredits;
            const creditPercent = ((creditsUsed / total) * 100).toFixed(1);
            document.getElementById('creditsUsed').textContent = `$${creditsUsed.toFixed(2)}`;
            document.getElementById('creditsRemaining').textContent = `$${creditsRemaining.toFixed(2)}`;
            document.getElementById('daysRemaining').textContent = daysLeft;
            document.getElementById('creditPercent').textContent = `${creditPercent}%`;
            document.getElementById('creditProgressBar').style.width = `${creditPercent}%`;

            // Update Document AI
            const docAiRemaining = BILLING.documentAI.freeLimit - docAiUsed;
            const docAiPercent = ((docAiUsed / BILLING.documentAI.freeLimit) * 100).toFixed(1);
            document.getElementById('docAiUsed').textContent = docAiUsed;
            document.getElementById('docAiRemaining').textContent = docAiRemaining;
            document.getElementById('docAiPercent').textContent = `${docAiPercent}%`;
            const bar = document.getElementById('docAiProgressBar');
            bar.style.width = `${docAiPercent}%`;
            bar.style.background = getUsageColor(docAiUsed);
            document.getElementById('docAiTableUsage').textContent = `${docAiUsed} / 1000 free`;

            // Reset date
            document.getElementById('docAiReset').textContent = BILLING.documentAI.resetDate.toLocaleDateString();

            // Total cost
            const totalCost = Object.values(BILLING.costs).reduce((a, b) => a + b, 0);
            document.getElementById('totalMonthlyCost').textContent = `$${totalCost.toFixed(2)}`;

            // Budget Alerts
            const alertZone = document.getElementById('budgetAlertZone');
            if (docAiUsed > 900) {
                alertZone.innerHTML = `
                    <div class="alert alert-danger">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            <i class="fas fa-exclamation-circle"></i> Approaching Free Tier Limit
                        </div>
                        <div style="font-size: 14px; color: var(--text-muted);">
                            You've used ${docAiUsed} of 1,000 free Document AI pages this month.
                        </div>
                    </div>`;
            } else if (creditsRemaining < 50) {
                alertZone.innerHTML = `
                    <div class="alert alert-warning">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            <i class="fas fa-exclamation-triangle"></i> Low GCP Credits
                        </div>
                        <div style="font-size: 14px; color: var(--text-muted);">
                            Only $${creditsRemaining} remaining. Credits expire in ${daysLeft} days.
                        </div>
                    </div>`;
            } else {
                alertZone.innerHTML = '';
            }
        }

        async function refreshDocAIUsageInSettings() {
            const usage = await fetchDocumentAIUsage();
            const remaining = 1000 - usage;
            const percent = ((usage / 1000) * 100).toFixed(1);

            document.getElementById('settingsDocAiUsed').textContent = usage;
            document.getElementById('settingsDocAiRemaining').textContent = remaining;
            document.getElementById('settingsDocAiPercent').textContent = `${percent}%`;
            const bar = document.getElementById('settingsDocAiBar');
            bar.style.width = `${percent}%`;
            bar.style.background = getUsageColor(usage);
        }

        // Initial load
        updateBillingDashboard();
        refreshDocAIUsageInSettings();
    </script>
</body>
</html>
