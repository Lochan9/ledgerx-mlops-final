<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LedgerX - Enterprise Invoice Intelligence Platform</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0E7490;
            --primary-dark: #164E63;
            --primary-light: #06B6D4;
            --accent: #38BDF8;
            --success: #22C55E;
            --warning: #FACC15;
            --danger: #EF4444;
            --info: #3B82F6;
            --bg-main: #F0F9FF;
            --surface: #FFFFFF;
            --text-main: #0F172A;
            --text-muted: #64748B;
            --border: rgba(148,163,184,0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-main);
            color: var(--text-main);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Dark Modern */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #0F172A 0%, #1E293B 100%);
            color: white;
            padding: 24px 16px;
            position: fixed;
            height: 100vh;
            box-shadow: 4px 0 24px rgba(0,0,0,0.12);
        }

        .logo {
            font-size: 24px;
            font-weight: 900;
            margin-bottom: 40px;
            padding: 0 12px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item {
            padding: 14px 16px;
            margin: 6px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(56,189,248,0.15);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(14,116,144,0.4);
        }

        .nav-item i {
            width: 20px;
            font-size: 18px;
        }

        /* Main Content */
        .main {
            margin-left: 260px;
            flex: 1;
            padding: 40px;
            max-width: 1600px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 16px;
            margin-bottom: 32px;
        }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .card-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 40px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .card-trend {
            font-size: 14px;
            color: var(--success);
            font-weight: 600;
        }

        /* Upload Zone */
        .upload-zone {
            background: white;
            border: 3px dashed var(--primary-light);
            border-radius: 20px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 32px;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(6,182,212,0.03);
            transform: scale(1.01);
        }

        .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(6,182,212,0.08);
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(14,116,144,0.2);
        }

        .upload-icon {
            font-size: 72px;
            color: var(--primary-light);
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 15px;
            margin-bottom: 24px;
        }

        .file-formats {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
        }

        .format-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(14,116,144,0.3);
        }

        /* Table */
        .table-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.06);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-head {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(14,116,144,0.05), rgba(6,182,212,0.05));
        }

        .table-title {
            font-size: 20px;
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 16px 24px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(248,250,252,0.8);
        }

        td {
            padding: 18px 24px;
            border-top: 1px solid var(--border);
        }

        tr:hover {
            background: rgba(6,182,212,0.03);
            cursor: pointer;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-success {
            background: rgba(34,197,94,0.12);
            color: #16A34A;
        }

        .badge-danger {
            background: rgba(239,68,68,0.12);
            color: #DC2626;
        }

        .badge-warning {
            background: rgba(250,204,21,0.12);
            color: #D97706;
        }

        .badge-info {
            background: rgba(59,130,246,0.12);
            color: #2563EB;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(14,116,144,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14,116,144,0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--text-main);
            border: 2px solid var(--border);
        }

        /* Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-indicator.connected {
            background: rgba(34,197,94,0.12);
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .spinner {
            border: 3px solid rgba(14,116,144,0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-bar {
            position: relative;
            margin-bottom: 24px;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(6,182,212,0.1);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 18px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-chip {
            padding: 16px 20px;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .stat-chip .label {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-chip .value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 72px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .result-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(148,163,184,0.1);
        }

        .result-icon {
            font-size: 28px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 700;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .result-item {
            padding: 16px;
            background: rgba(6,182,212,0.04);
            border-radius: 10px;
            border: 1px solid rgba(6,182,212,0.15);
        }

        .result-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .result-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-main);
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 28px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(14,116,144,0.05), rgba(6,182,212,0.05));
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-body {
            padding: 28px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(239,68,68,0.1);
            color: var(--danger);
        }

        .btn-icon {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: rgba(148,163,184,0.1);
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
        }

        .thumbnail {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(14,116,144,0.1), rgba(6,182,212,0.1));
            border-radius: 10px;
            font-size: 24px;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-file-invoice"></i> LedgerX
            </div>
            
            <nav>
                <div class="nav-item active" onclick="showPage('overview')">
                    <i class="fas fa-chart-line"></i>
                    <span>Overview</span>
                </div>
                <div class="nav-item" onclick="showPage('upload')">
                    <i class="fas fa-upload"></i>
                    <span>Upload Invoice</span>
                </div>
                <div class="nav-item" onclick="showPage('history')">
                    <i class="fas fa-history"></i>
                    <span>Invoice History</span>
                </div>
                <div class="nav-item" onclick="showPage('analytics')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
            </nav>

            <div style="margin-top: auto; padding-top: 32px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div id="connectionStatus" class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Connecting...</span>
                </div>
                <div style="margin-top: 16px; font-size: 12px; color: rgba(255,255,255,0.5);">
                    <div>Version 2.2.0</div>
                    <div id="userInfo">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Overview Page -->
            <div id="overview" class="page active">
                <h1 class="page-title">üìä Dashboard Overview</h1>
                <p class="page-subtitle">Real-time intelligence for your invoice processing</p>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-label">Total Invoices</div>
                        <div class="card-value" id="totalInvoices">0</div>
                        <div class="card-trend"><i class="fas fa-file-invoice"></i> All time</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-label">Quality Score</div>
                        <div class="card-value" style="color: var(--success)" id="avgQuality">-</div>
                        <div class="card-trend"><i class="fas fa-check-circle"></i> Average</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-label">Failure Risk</div>
                        <div class="card-value" style="color: var(--warning)" id="avgFailure">-</div>
                        <div class="card-trend"><i class="fas fa-exclamation-triangle"></i> Average</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-label">Processed Today</div>
                        <div class="card-value" id="todayCount">0</div>
                        <div class="card-trend"><i class="fas fa-calendar-day"></i> Last 24 hours</div>
                    </div>
                </div>

                <div class="table-box">
                    <div class="table-head">
                        <h3 class="table-title">üìã Recent Activity</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Vendor</th>
                                <th>Amount</th>
                                <th>Quality</th>
                                <th>Risk</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivity">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                                    <div>No invoices processed yet</div>
                                    <div style="margin-top: 16px;">
                                        <button class="btn btn-primary" onclick="showPage('upload')">
                                            <i class="fas fa-upload"></i> Upload Your First Invoice
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Upload Page -->
            <div id="upload" class="page">
                <h1 class="page-title">üì§ Upload Invoice</h1>
                <p class="page-subtitle">Just upload - AI will extract and process automatically!</p>

                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="fileInput" accept=".jpg,.jpeg,.png,.pdf,.json" style="display:none" multiple>
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <div class="upload-text">Drop files here or click to upload</div>
                    <div class="upload-subtext">Auto-extraction with OCR ‚Ä¢ Instant ML processing</div>
                    <div class="file-formats">
                        <span class="format-badge"><i class="fas fa-file-image"></i> JPG/PNG</span>
                        <span class="format-badge"><i class="fas fa-file-pdf"></i> PDF</span>
                        <span class="format-badge"><i class="fas fa-file-code"></i> JSON</span>
                    </div>
                </div>

                <div id="processingQueue"></div>
                <div id="results"></div>
            </div>

            <!-- Invoice History -->
            <div id="history" class="page">
                <h1 class="page-title">üìú Invoice History</h1>
                <p class="page-subtitle">Complete history of all processed invoices</p>

                <div class="stats-summary">
                    <div class="stat-chip">
                        <span class="label">Total Invoices</span>
                        <span class="value" id="historyTotal">0</span>
                    </div>
                    <div class="stat-chip">
                        <span class="label">High Quality</span>
                        <span class="value" id="historyGood">0</span>
                    </div>
                    <div class="stat-chip">
                        <span class="label">Low Quality</span>
                        <span class="value" id="historyBad">0</span>
                    </div>
                    <div class="stat-chip">
                        <span class="label">At Risk</span>
                        <span class="value" id="historyRisk">0</span>
                    </div>
                </div>

                <div class="search-bar">
                    <i class="search-icon fas fa-search"></i>
                    <input type="text" class="search-input" id="historySearch" 
                           placeholder="Search by invoice number, vendor, or amount..." 
                           oninput="filterHistory()">
                </div>

                <div class="filters">
                    <button class="filter-btn active" onclick="filterByQuality('all')">All</button>
                    <button class="filter-btn" onclick="filterByQuality('good')">
                        <i class="fas fa-check-circle"></i> Good Quality
                    </button>
                    <button class="filter-btn" onclick="filterByQuality('bad')">
                        <i class="fas fa-times-circle"></i> Low Quality
                    </button>
                    <button class="filter-btn" onclick="filterByFormat('image')">
                        <i class="fas fa-image"></i> Images
                    </button>
                    <button class="filter-btn" onclick="filterByFormat('pdf')">
                        <i class="fas fa-file-pdf"></i> PDFs
                    </button>
                </div>

                <div class="table-box">
                    <div class="table-head">
                        <h3 class="table-title">All Invoices</h3>
                        <button class="btn btn-secondary" onclick="exportHistory()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>File Name</th>
                                <th>Format</th>
                                <th>Vendor</th>
                                <th>Amount</th>
                                <th>Quality</th>
                                <th>Risk</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <div class="empty-icon"><i class="fas fa-folder-open"></i></div>
                                    <div>No invoices in history yet</div>
                                    <div style="margin-top: 16px;">
                                        <button class="btn btn-primary" onclick="showPage('upload')">
                                            <i class="fas fa-upload"></i> Upload Your First Invoice
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analytics" class="page">
                <h1 class="page-title">üìà Analytics</h1>
                <p class="page-subtitle">Insights and trends from your invoice data</p>

                <div class="card-grid">
                    <div class="card">
                        <div class="card-label">Quality Model F1</div>
                        <div class="card-value" style="color: var(--success)">97.7%</div>
                        <div class="card-trend"><i class="fas fa-trophy"></i> CatBoost</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Failure Model F1</div>
                        <div class="card-value" style="color: var(--success)">91.3%</div>
                        <div class="card-trend"><i class="fas fa-trophy"></i> LogisticRegression</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Avg Latency</div>
                        <div class="card-value">35ms</div>
                        <div class="card-trend"><i class="fas fa-bolt"></i> Production</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Cache Hit Rate</div>
                        <div class="card-value">66.7%</div>
                        <div class="card-trend"><i class="fas fa-database"></i> Optimized</div>
                    </div>
                </div>

                <div class="table-box">
                    <div class="table-head">
                        <h3 class="table-title">üìä Processing Trends</h3>
                    </div>
                    <div style="padding: 32px;">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings" class="page">
                <h1 class="page-title">‚öôÔ∏è Settings</h1>
                <p class="page-subtitle">Configure your LedgerX instance</p>

                <div class="card">
                    <h3 style="margin-bottom: 24px; font-size: 18px; font-weight: 700;">API Configuration</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">API Endpoint</label>
                        <input type="text" id="apiUrlSetting" value="https://ledgerx-api-zyz6umftna-uc.a.run.app" 
                               style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 15px;">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <h3 style="margin-bottom: 24px; font-size: 18px; font-weight: 700;">Data Management</h3>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="exportAllData()">
                            <i class="fas fa-download"></i> Export All Data
                        </button>
                        <button class="btn btn-secondary" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> Clear History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-backdrop" id="invoiceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">üìÑ Invoice Details</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 16px; width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 8px; color: var(--primary);">
                <i class="fas fa-lock"></i> Login Required
            </h2>
            <p style="color: var(--text-muted); margin-bottom: 24px;">Sign in to access LedgerX</p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main);">Username</label>
                <input type="text" id="loginUsername" placeholder="admin" 
                    style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;"
                    onkeypress="if(event.key === 'Enter') document.getElementById('loginPassword').focus()">
            </div>
            
            <div style="margin-bottom: 24px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main);">Password</label>
                <input type="password" id="loginPassword" placeholder="admin123" 
                    style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;"
                    onkeypress="if(event.key === 'Enter') attemptLogin()">
            </div>
            
            <div id="loginError" style="display: none; padding: 12px; background: #FEE; border-radius: 8px; color: var(--danger); margin-bottom: 16px; font-size: 14px;">
            </div>
            
            <button onclick="attemptLogin()" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 16px; margin-bottom: 16px;">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
            
            <div style="padding: 16px; background: var(--bg-main); border-radius: 8px; font-size: 13px; color: var(--text-muted);">
                <strong style="display: block; margin-bottom: 8px;">Test Credentials:</strong>
                ‚Ä¢ Username: <code style="background: white; padding: 2px 6px; border-radius: 4px;">admin</code> Password: <code style="background: white; padding: 2px 6px; border-radius: 4px;">admin123</code><br>
                ‚Ä¢ Username: <code style="background: white; padding: 2px 6px; border-radius: 4px;">john_doe</code> Password: <code style="background: white; padding: 2px 6px; border-radius: 4px;">password123</code>
            </div>
        </div>
    </div>

    <script>
        const STATE = {
            apiUrl: 'https://ledgerx-api-671429123152.us-central1.run.app',
            token: null,
            username: null,
            invoices: [],
            filtered: [],
            filter: { quality: 'all', format: 'all', search: '' }
        };

        // Login Functions
        async function attemptLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);

                const res = await fetch(`${STATE.apiUrl}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!res.ok) {
                    throw new Error('Invalid credentials');
                }

                const data = await res.json();
                STATE.token = data.access_token;
                STATE.username = username;

                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                errorDiv.style.display = 'none';

                console.log('‚úÖ Login successful');

            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
                console.error('Login failed:', error);
            }
        }

        function logout() {
            STATE.token = null;
            STATE.username = null;
            document.getElementById('loginModal').style.display = 'flex';
        }

        function checkAuth() {
            if (!STATE.token) {
                document.getElementById('loginModal').style.display = 'flex';
                return false;
            }
            return true;
        }

        window.onload = async () => {
            loadData();
            
            // Check if logged in
            if (!STATE.token) {
                document.getElementById('loginModal').style.display = 'flex';
            }
            
            await connect();
            setup();
            updateAll();
        };

        function loadData() {
            try {
                const saved = localStorage.getItem('ledgerx_data');
                if (saved) STATE.invoices = JSON.parse(saved);
            } catch (e) {
                console.warn('localStorage blocked, using session only');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('ledgerx_data', JSON.stringify(STATE.invoices));
            } catch (e) {
                console.warn('localStorage blocked, data will not persist');
            }
        }

        async function connect() {
            try {
                const res = await fetch(`${STATE.apiUrl}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'username=admin&password=admin123'
                });
                const data = await res.json();
                STATE.token = data.access_token;
                
                document.getElementById('connectionStatus').innerHTML = '<div class="status-dot"></div><span>Connected</span>';
                document.getElementById('connectionStatus').className = 'status-indicator connected';
                document.getElementById('userInfo').textContent = 'admin';
            } catch (e) {
                console.error(e);
            }
        }

        function setup() {
            const zone = document.getElementById('uploadZone');
            const input = document.getElementById('fileInput');

            zone.onclick = () => input.click();
            input.onchange = (e) => {
                Array.from(e.target.files).forEach(f => processFile(f));
                input.value = '';
            };

            zone.ondragover = (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            };
            zone.ondragleave = () => zone.classList.remove('dragover');
            zone.ondrop = (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                Array.from(e.dataTransfer.files).forEach(f => processFile(f));
            };

            initCharts();
        }

        async function processFile(file) {
            // Check authentication first
            if (!checkAuth()) {
                alert('Please login first');
                return;
            }

            const valid = ['.jpg', '.jpeg', '.png', '.pdf'];
            if (!valid.some(ext => file.name.toLowerCase().endsWith(ext))) {
                alert('Invalid file type. Please upload JPG, PNG, or PDF.');
                return;
            }

            const fmt = file.type.startsWith('image/') ? 'IMAGE' : 'PDF';
            
            const queueDiv = document.getElementById('processingQueue');
            const cardId = `proc-${Date.now()}`;
            
            queueDiv.innerHTML += `
                <div class="card" id="${cardId}" style="text-align: center;">
                    <div class="spinner"></div>
                    <h3 style="margin-top: 20px;">${file.name}</h3>
                    <p style="color: var(--text-muted); margin-top: 8px;">${fmt} ‚Ä¢ ${(file.size/1024).toFixed(2)} KB</p>
                    <p style="color: var(--primary); margin-top: 12px; font-weight: 600;">
                        <i class="fas fa-magic"></i> Auto-extracting with OCR...
                    </p>
                </div>
            `;

            try {
                // üî• REAL API CALL - Upload image to backend WITH AUTH
                const formData = new FormData();
                formData.append('file', file);

                const res = await fetch('https://ledgerx-api-671429123152.us-central1.run.app/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${STATE.token}`
                    },
                    body: formData
                });

                if (!res.ok) {
                    throw new Error(`API Error: ${res.status} ${res.statusText}`);
                }

                const result = await res.json();

                // Extract data from API response
                const data = result.extracted_data || {};
                
                const invoice = {
                    id: Date.now(),
                    fileName: file.name,
                    fileType: fmt,
                    fileSize: file.size,
                    invoice_number: data.invoice_number || 'N/A',
                    vendor_name: data.vendor_name || 'Unknown',
                    total_amount: data.total_amount || 0,
                    currency: data.currency || 'USD',
                    invoice_date: data.invoice_date || new Date().toISOString().split('T')[0],
                    vendor_freq: data.vendor_freq || 0,
                    blur_score: data.blur_score || 0,
                    contrast_score: data.contrast_score || 0,
                    ocr_confidence: data.ocr_confidence || 0,
                    file_size_kb: file.size / 1024,
                    quality: result.quality?.prediction || result.quality?.quality || 'unknown',
                    qualityScore: result.quality?.probabilities?.good || result.quality?.probability || 0,
                    risk: result.failure?.prediction || result.failure?.risk || 'unknown',
                    riskScore: result.failure?.probabilities?.risk || result.failure?.probability || 0,
                    timestamp: new Date().toISOString(),
                    result
                };

                STATE.invoices.unshift(invoice);
                saveData();

                document.getElementById(cardId).innerHTML = `
                    <i class="fas fa-check-circle" style="font-size: 60px; color: var(--success);"></i>
                    <h3 style="margin-top: 16px; color: var(--success);">‚úÖ Processed Successfully!</h3>
                    <p style="margin-top: 12px;">${file.name}</p>
                    <p style="margin-top: 8px; font-size: 14px; color: var(--text-muted);">
                        ${invoice.vendor_name} ‚Ä¢ ${invoice.currency} ${invoice.total_amount}
                    </p>
                    <div style="margin-top: 16px; display: flex; gap: 12px; justify-content: center;">
                        <span class="badge badge-${invoice.quality === 'good' ? 'success' : 'danger'}">
                            ${invoice.quality}
                        </span>
                        <span class="badge badge-${invoice.risk === 'safe' || invoice.risk === 'low' ? 'success' : 'warning'}">
                            ${invoice.risk}
                        </span>
                    </div>
                `;

                setTimeout(() => document.getElementById(cardId).remove(), 3000);
                updateAll();

            } catch (error) {
                console.error('Upload error:', error);
                
                const errorMsg = error.message || error.toString() || 'Unknown error';
                
                document.getElementById(cardId).innerHTML = `
                    <i class="fas fa-times-circle" style="font-size: 60px; color: var(--danger);"></i>
                    <h3 style="margin-top: 16px; color: var(--danger);">Processing Failed</h3>
                    <p style="margin-top: 8px; color: var(--text-muted);">${errorMsg}</p>
                    <p style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                        ${error.message && error.message.includes('401') ? 'üîí Please login first' : 'Check console for details'}
                    </p>
                `;
            }
        }

        function updateAll() {
            document.getElementById('totalInvoices').textContent = STATE.invoices.length;
            document.getElementById('historyTotal').textContent = STATE.invoices.length;
            
            const good = STATE.invoices.filter(i => i.quality === 'good').length;
            const bad = STATE.invoices.filter(i => i.quality === 'bad').length;
            const risk = STATE.invoices.filter(i => i.risk === 'risk').length;

            document.getElementById('historyGood').textContent = good;
            document.getElementById('historyBad').textContent = bad;
            document.getElementById('historyRisk').textContent = risk;

            if (STATE.invoices.length > 0) {
                const avgQ = (STATE.invoices.reduce((s, i) => s + (i.qualityScore || 0), 0) / STATE.invoices.length * 100).toFixed(1);
                const avgR = (STATE.invoices.reduce((s, i) => s + (i.riskScore || 0), 0) / STATE.invoices.length * 100).toFixed(1);
                document.getElementById('avgQuality').textContent = avgQ + '%';
                document.getElementById('avgFailure').textContent = avgR + '%';
            }

            const today = new Date().toISOString().split('T')[0];
            const todayCount = STATE.invoices.filter(i => i.timestamp.startsWith(today)).length;
            document.getElementById('todayCount').textContent = todayCount;

            renderHistory();
            renderRecent();
        }

        function renderHistory() {
            STATE.filtered = STATE.invoices.filter(inv => {
                if (STATE.filter.quality !== 'all' && inv.quality !== STATE.filter.quality) return false;
                if (STATE.filter.format === 'image' && inv.fileType !== 'IMAGE') return false;
                if (STATE.filter.format === 'pdf' && inv.fileType !== 'PDF') return false;
                if (STATE.filter.search) {
                    const s = STATE.filter.search.toLowerCase();
                    const txt = `${inv.fileName} ${inv.vendor_name} ${inv.invoice_number}`.toLowerCase();
                    if (!txt.includes(s)) return false;
                }
                return true;
            });

            const tbody = document.getElementById('historyTable');
            
            if (STATE.filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="empty-state"><div class="empty-icon"><i class="fas fa-search"></i></div><div>No invoices match your filters</div></td></tr>`;
                return;
            }

            tbody.innerHTML = STATE.filtered.map(inv => `
                <tr onclick="showDetails(${inv.id})">
                    <td><div class="thumbnail"><i class="fas ${inv.fileType === 'PDF' ? 'fa-file-pdf' : 'fa-file-image'}"></i></div></td>
                    <td><strong>${inv.fileName}</strong></td>
                    <td><span class="badge badge-info">${inv.fileType}</span></td>
                    <td>${inv.vendor_name}</td>
                    <td>${inv.currency} ${inv.total_amount.toFixed(2)}</td>
                    <td><span class="badge badge-${inv.quality === 'good' ? 'success' : 'danger'}">${inv.quality}</span></td>
                    <td><span class="badge badge-${inv.risk === 'safe' ? 'success' : 'warning'}">${inv.risk}</span></td>
                    <td>${new Date(inv.timestamp).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteInvoice(${inv.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecent() {
            const tbody = document.getElementById('recentActivity');
            const recent = STATE.invoices.slice(0, 10);

            if (recent.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><div class="empty-icon"><i class="fas fa-inbox"></i></div><div>No invoices yet</div></td></tr>`;
                return;
            }

            tbody.innerHTML = recent.map(inv => `
                <tr onclick="showDetails(${inv.id})">
                    <td><strong>${inv.invoice_number}</strong></td>
                    <td>${inv.vendor_name}</td>
                    <td>${inv.currency} ${inv.total_amount.toFixed(2)}</td>
                    <td><span class="badge badge-${inv.quality === 'good' ? 'success' : 'danger'}">${inv.quality}</span></td>
                    <td><span class="badge badge-${inv.risk === 'safe' ? 'success' : 'warning'}">${inv.risk}</span></td>
                    <td>${new Date(inv.timestamp).toLocaleTimeString()}</td>
                </tr>
            `).join('');
        }

        function showDetails(id) {
            const inv = STATE.invoices.find(i => i.id === id);
            if (!inv) return;

            document.getElementById('modalBody').innerHTML = `
                <div class="result-section">
                    <div class="result-header">
                        <i class="result-icon fas fa-file-invoice"></i>
                        <div class="result-title">Invoice Information</div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Invoice #</div>
                            <div class="result-value">${inv.invoice_number}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Vendor</div>
                            <div class="result-value">${inv.vendor_name}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Amount</div>
                            <div class="result-value">${inv.currency} ${inv.total_amount.toFixed(2)}</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">File Type</div>
                            <div class="result-value"><span class="badge badge-info">${inv.fileType}</span></div>
                        </div>
                    </div>
                </div>
                <div class="result-section">
                    <div class="result-header">
                        <i class="result-icon fas fa-check-circle" style="color: var(--${inv.quality === 'good' ? 'success' : 'danger'});"></i>
                        <div class="result-title">Quality Results</div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Prediction</div>
                            <div class="result-value"><span class="badge badge-${inv.quality === 'good' ? 'success' : 'danger'}">${inv.quality}</span></div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Score</div>
                            <div class="result-value">${(inv.qualityScore * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px; display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="btn btn-primary" onclick="deleteInvoice(${inv.id}); closeModal();">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            `;

            document.getElementById('invoiceModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('invoiceModal').classList.remove('active');
        }

        function deleteInvoice(id) {
            if (!confirm('Delete this invoice?')) return;
            STATE.invoices = STATE.invoices.filter(i => i.id !== id);
            saveData();
            updateAll();
        }

        function filterByQuality(q) {
            STATE.filter.quality = q;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderHistory();
        }

        function filterByFormat(f) {
            STATE.filter.format = f;
            renderHistory();
        }

        function filterHistory() {
            STATE.filter.search = document.getElementById('historySearch').value;
            renderHistory();
        }

        function exportHistory() {
            if (STATE.invoices.length === 0) return alert('No data');
            const csv = [
                ['File','Format','Vendor','Amount','Quality','Risk','Date'].join(','),
                ...STATE.invoices.map(i => [
                    i.fileName, i.fileType, i.vendor_name, i.total_amount, 
                    i.quality, i.risk, i.invoice_date
                ].join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ledgerx_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function exportAllData() {
            const json = JSON.stringify(STATE.invoices, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ledgerx_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function clearAllData() {
            if (!confirm('Delete all history?')) return;
            STATE.invoices = [];
            saveData();
            updateAll();
        }

        function saveSettings() {
            STATE.apiUrl = document.getElementById('apiUrlSetting').value;
            saveData();
            connect();
            alert('Settings saved!');
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            if (page === 'history') renderHistory();
        }

        function initCharts() {
            const ctx = document.getElementById('trendChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Invoices',
                            data: [12, 19, 15, 25, 22, 18, 24],
                            borderColor: '#0E7490',
                            backgroundColor: 'rgba(14,116,144,0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
    </script>
</body>
</html>