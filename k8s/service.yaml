# k8s/service.yaml
# Kubernetes Service for LedgerX API (Internal)

apiVersion: v1
kind: Service
metadata:
  name: ledgerx-svc
  namespace: ledgerx
  labels:
    app: ledgerx-api
  annotations:
    cloud.google.com/neg: '{"ingress": true}'  # Network Endpoint Groups for Ingress
    cloud.google.com/backend-config: '{"default": "ledgerx-backendconfig"}'
spec:
  type: ClusterIP  # Internal service, exposed via Ingress
  selector:
    app: ledgerx-api
  ports:
  - name: http
    protocol: TCP
    port: 80          # Service port
    targetPort: 8000  # Container port
  sessionAffinity: None  # Stateless application

---
# BackendConfig for advanced load balancer settings
apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: ledgerx-backendconfig
  namespace: ledgerx
spec:
  # Health Check Configuration
  healthCheck:
    checkIntervalSec: 10
    timeoutSec: 5
    healthyThreshold: 2
    unhealthyThreshold: 3
    type: HTTP
    requestPath: /health
    port: 8000
  
  # Connection Draining (for graceful shutdowns)
  connectionDraining:
    drainingTimeoutSec: 60
  
  # Session Affinity (optional, for sticky sessions)
  sessionAffinity:
    affinityType: "NONE"  # or "CLIENT_IP" for sticky sessions
    affinityCookieTtlSec: 0
  
  # Timeout Configuration
  timeoutSec: 30
  
  # Cloud CDN (optional, for static assets)
  # cdn:
  #   enabled: false
  #   cachePolicy:
  #     includeHost: true
  #     includeProtocol: true
  #     includeQueryString: false
  
  # IAP (Identity-Aware Proxy) - optional for authentication
  # iap:
  #   enabled: false
  #   oauthclientCredentials:
  #     secretName: oauth-client-secret