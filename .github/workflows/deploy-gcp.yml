name: Complete MLOps CI/CD - Cloud Run Deployment

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'models/**'
      - 'Dockerfile.cloudrun'
      - 'requirements*.txt'
  workflow_dispatch:

env:
  PROJECT_ID: ledgerx-mlops
  REGION: us-central1
  SERVICE_NAME: ledgerx-api
  REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: ledgerx-docker
  IMAGE_NAME: ledgerx-api
  MIN_F1_QUALITY: 0.70
  MIN_F1_FAILURE: 0.65

jobs:
  pull-and-validate:
    name: Pull Latest Models from Registry
    runs-on: ubuntu-latest
    outputs:
      models_updated: ${{ steps.check_models.outputs.updated }}
      quality_f1: ${{ steps.evaluate.outputs.quality_f1 }}
      failure_f1: ${{ steps.evaluate.outputs.failure_f1 }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install dvc[gs]
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Pull Latest Models from DVC/GCS
        run: |
          echo "Pulling latest models from remote storage..."
          dvc remote modify myremote url gs://ledgerx-dvc-671429123152
          dvc pull models/compressed/quality_model.pkl.dvc
          dvc pull models/compressed/failure_model.pkl.dvc
          echo "Models pulled successfully"
          ls -lh models/compressed/
      - name: Check Model Updates
        id: check_models
        run: |
          if git diff --name-only HEAD~1 | grep -q "models/"; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "New models detected"
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "No model updates"
          fi
      - name: Validate Model Performance
        id: evaluate
        run: |
          echo "Evaluating model performance..."
          python src/training/evaluate_models.py
          QUALITY_F1=$(python -c "import json; print(json.load(open('reports/model_leaderboard.json'))['quality'][0]['f1'])")
          FAILURE_F1=$(python -c "import json; print(json.load(open('reports/model_leaderboard.json'))['failure'][0]['f1'])")
          echo "quality_f1=$QUALITY_F1" >> $GITHUB_OUTPUT
          echo "failure_f1=$FAILURE_F1" >> $GITHUB_OUTPUT
          echo "Quality Model F1: $QUALITY_F1"
          echo "Failure Model F1: $FAILURE_F1"
          python -c "
          quality_f1 = float('$QUALITY_F1')
          failure_f1 = float('$FAILURE_F1')
          assert quality_f1 >= ${MIN_F1_QUALITY}, f'Quality F1 {quality_f1:.3f} below threshold'
          assert failure_f1 >= ${MIN_F1_FAILURE}, f'Failure F1 {failure_f1:.3f} below threshold'
          print('Model performance validated!')
          "
      - name: Upload Models as Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ml-models
          path: |
            models/compressed/*.pkl
            models/*.cbm
          retention-days: 30

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: pull-and-validate
    outputs:
      image_url: ${{ steps.build.outputs.image_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download Models
        uses: actions/download-artifact@v3
        with:
          name: ml-models
          path: models/
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      - name: Build Docker Image
        id: build
        run: |
          IMAGE_URL="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          IMAGE_TAG="v$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA:0:7}"
          echo "Building image: $IMAGE_URL:$IMAGE_TAG"
          docker build -f Dockerfile.cloudrun -t "$IMAGE_URL:latest" -t "$IMAGE_URL:$IMAGE_TAG" .
          echo "image_url=$IMAGE_URL:$IMAGE_TAG" >> $GITHUB_OUTPUT
      - name: Push to Registry
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ steps.build.outputs.image_url }}

  deploy-to-cloudrun:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8000 \
            --cpu 2 \
            --memory 2Gi \
            --timeout 300 \
            --min-instances 0 \
            --max-instances 10 \
            --set-env-vars "ENVIRONMENT=production,PROJECT_ID=${{ env.PROJECT_ID }}"
      - name: Get Service URL
        id: get_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service URL: $SERVICE_URL"
      - name: Health Check
        run: |
          sleep 15
          SERVICE_URL="${{ steps.get_url.outputs.service_url }}"
          curl -f "$SERVICE_URL/health" || exit 1
          echo "Health check passed"
      - name: Log Deployment
        run: |
          echo "Deployment Summary"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "URL: ${{ steps.get_url.outputs.service_url }}"
          echo "Deployed at: $(date -u)"