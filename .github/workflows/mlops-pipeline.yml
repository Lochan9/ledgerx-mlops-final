name: LedgerX MLOps Pipeline - Enhanced CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'dvc.yaml'
      - 'requirements.txt'
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.12'
  MIN_COVERAGE: 80
  MIN_F1_SCORE: 0.90

jobs:
  # ============================================================================
  # JOB 1: TEST & VALIDATE
  # ============================================================================
  test-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    
    - name: ğŸ“š Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: ğŸ§ª Run tests with coverage
      run: |
        pytest tests/ -v --cov=src --cov-report=xml
        
    - name: ğŸ“Š Check coverage
      run: |
        coverage report --fail-under=${{ env.MIN_COVERAGE }}
      continue-on-error: true

  # ============================================================================
  # JOB 2: MODEL TRAINING & VALIDATION
  # ============================================================================
  train-and-register:
    runs-on: ubuntu-latest
    needs: test-and-validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“š Install dependencies
      run: pip install -r requirements.txt
    
    - name: ğŸ¯ Hyperparameter tuning
      run: python src/training/hyperparameter_tuning.py --quick
      continue-on-error: true
    
    - name: ğŸ¤– Train models
      run: python src/training/train_all_models.py
    
    - name: ğŸ“Š Evaluate models
      run: python src/training/evaluate_models.py
    
    - name: ğŸ” Bias detection
      run: python src/training/error_analysis.py
      continue-on-error: true
    
    - name: âœ… Validate performance
      run: |
        python -c "
        import json
        with open('reports/model_leaderboard.json') as f:
            data = json.load(f)
        quality_f1 = data['quality'][0]['f1']
        failure_f1 = data['failure'][0]['f1']
        assert quality_f1 >= ${{ env.MIN_F1_SCORE }}
        assert failure_f1 >= 0.85
        print('âœ… Performance validated')
        "
    
    - name: ğŸ—„ï¸ Register models
      run: python src/training/register_models.py
    
    - name: ğŸ’¾ Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: models-and-reports
        path: |
          models/*.pkl
          reports/**

  # ============================================================================
  # JOB 3: DOCKER BUILD
  # ============================================================================
  docker-build:
    runs-on: ubuntu-latest
    needs: train-and-register
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3
    
    - name: ğŸ³ Build Docker
      run: docker build -t ledgerx-mlops:latest .
    
    - name: ğŸ§ª Test container
      run: docker run --rm ledgerx-mlops:latest python -c "import src.inference.api_fastapi; print('âœ… OK')"